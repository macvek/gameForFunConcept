<html>
    <body>

        <div id="boardOverlay"><div id="board"></div></div>

        <div id="debugpane">
            <button onclick="moveView(-1,0)">view LEFT</button>
            <button onclick="moveView(1,0)">view RIGHT</button>
            <button onclick="moveView(0,-1)">view UP</button>
            <button onclick="moveView(0,1)">view DOWN</button>
            <button onclick="animMoveView(-1,0)">animMove LEFT</button>
            <button onclick="animMoveView(1,0)">animMove RIGHT</button>
            <button onclick="animMoveView(0,-1)">animMove UP</button>
            <button onclick="animMoveView(0,1)">animMove DOWN</button>

        </div>
            
        <style>

            #boardOverlay {
                position: relative;
                border:1px solid #00f;
                width: 640px;
                height: 480px;
                overflow: hidden;
            }
            #board {
                position: relative;
            }

            .board-item {
                position: absolute;
                border:1px solid #f00;
                width:20px;
                height:20px;
            }

            #debugpane {
                position: fixed;
                display: flex;
                flex-flow: column;
                top:5px;
                right:5px;
                border:1px solid #ff0;
                padding: 10px;
            }

        </style>

        <script>
            window.Modules = {}
        </script>
        <script src="game.js"></script>
        <script>
            var board;
            window.addEventListener('load', function() {
                var game = new Modules.Game()
                board = new Board()
                game.startWithBoard(board)
                board.setOnClick(function(x,y) {
                    game.onClick(x,y)
                })

            })

            function Board() {
                this.board = document.getElementById('board')
                this.boardOverlay = document.getElementById('boardOverlay')
                this.cX = 0
                this.cY = 0
                this.oX = 0
                this.oY = 0
                this.fields = new XYMap()
                this.renderQueue = []
                var self = this
                this.animator = setInterval(function() {self.render() }, 1000/30)
            }

            Board.prototype.setOnClick = function(callback) {
                var self = this
                this.boardOverlay.addEventListener("click", function(e) {
                    var x = Math.max(0,Math.min(self.boardWX-1,e.offsetX))-self.oX
                    var y = Math.max(0,Math.min(self.boardWY-1,e.offsetY))-self.oY
                    console.log("onClick ",x,y)
                    callback(x,y)
                })
            }

            Board.prototype.fieldOf = function(aX,aY) {
                return {
                    x: Math.floor(aX / this.wX),
                    y: Math.floor(aY / this.wY)
                }
            }
            
            Board.prototype.fieldSize = function(aX,aY) {
                console.log('fieldSize',aX,aY)
                this.wX = aX
                this.wY = aY
            }

            Board.prototype.viewSize = function(aX,aY) {
                console.log('viewSize',aX,aY)
                this.boardWX = aX
                this.boardWY = aY
            }
            
            Board.prototype.newEntity = function() {
                return new BoardEntity(this)
            }

            Board.prototype.tryMove = function(what, aX,aY) {
                var self = this
                console.log("tryMove", aX,aY)
                what.x = aX
                what.y = aY

                var node

                if (!what._boardPriv) {
                    what._boardPriv = {}
                    node = this.createItem()
                    what._boardPriv.node = node 
                    appendNode()
                    putInPlace()
                    
                }
                else {
                    node = what._boardPriv.node
                    putInPlace()
                }

                function appendNode() {
                    self.renderQueue.push( function() {
                        self.board.appendChild(node)
                    })
                }

                function putInPlace() {
                    self.renderQueue.push( function() {
                        node.style.left = what.x * self.wX
                        node.style.top = what.y * self.wY
                    })
                } 

                this.fields.at(aX,aY).put(what)
            }

            Board.prototype.createItem = function() {
                var item = document.createElement("div")
                item.className = 'board-item'
                return item
            }

            Board.prototype.render = function() {
                var queue = this.renderQueue
                this.renderQueue = []
                for (each of queue) {
                    each()
                }
            }

            Board.prototype.offsetView = function(aX,aY) {
                var oX = aX * this.wX
                var oY = aY * this.wY
                
                this.setView(this.oX + oX, this.oY + oY)
            }

            Board.prototype.setView = function(aX,aY) {
                this.oX = aX;
                this.oY = aY;
                this.renderQueue.push(moveTo)
                var self = this;

                function moveTo() {
                    self.board.style.left = self.oX+"px"
                    self.board.style.top = self.oY+"px"
                }
            }

            Board.prototype.scheduleAnimation = function(time, callback) {
                var start = new Date().getTime()

                var root = this 
                addNextAnim()

                function performAnimation() {
                    var now = new Date().getTime()
                    var ratio = Math.min( (now-start) / time,1)
                    callback(ratio)
                    if (ratio < 1) {
                        addNextAnim()
                    }
                }

                function addNextAnim() {
                    root.renderQueue.push(performAnimation)
                }

            }

            Board.prototype.animMoveView = function(time, aX,aY) {
                var start = {
                    x: this.oX,
                    y: this.oY
                }

                var end = {
                    x: this.oX + aX * this.wX,
                    y: this.oY + aY * this.wY
                }

                var self = this
                this.scheduleAnimation(time, function(ratio) {
                    if (ratio == 1) {
                        self.setView(end.x,end.y)
                    }
                    else {
                        self.setView(start.x + (end.x-start.x)*ratio, start.y + (end.y-start.y)*ratio)
                    }
                })
            }

            function XYMap() {
                this.fields = []
            }

            XYMap.prototype.at = function(x,y) {
                var parent = this
                return {
                    is : function() {
                        if (parent.fields[x] && parent.fields[x][y]) {
                            return parent.fields[x][y]
                        }
                    },
                    put : function(what) {
                        if (parent.fields[x]) {
                            parent.fields[x][y] = what
                        }
                        else {
                            var sub = []
                            sub[y] = what
                            parent.fields[x] = sub
                        }
                    }

                }
            }
            
            function BoardEntity(board) {
                this.board = board
            }

            BoardEntity.prototype.putTo = function(aX,aY) {
                console.log("putTo",aX,aY)
                this.board.tryMove(this,aX,aY)

            }

            function moveView(offX,offY) {
                board.offsetView(offX,offY)
            }

            function animMoveView(aX,aY) {
                board.animMoveView(200,aX,aY)
            }

        </script>
    </body>
</html>